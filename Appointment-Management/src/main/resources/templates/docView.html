<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.js"></script>
    <link rel="stylesheet" href="css/docView.css">
    <title>Doctor's Upcoming Appointments</title>


</head>
<body>

    <div class="sidebar" id="sidebar">
        <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>

        <a href="#appointments" >
            <i class="fa fa-history" aria-hidden="true"></i> <span class="menu-label">Appointments</span>
        </a>
        <a href="#bookAppointments" class="active">
            <i class="fa fa-calendar-o" aria-hidden="true"></i>
        <span class="menu-label"> Book Appointments</span>
        </a>
        <a href="#profile">
            <i class="fa fa-user" aria-hidden="true"></i>
 <span class="menu-label">Profile</span>
        </a>
        <a href="javascript:void(0)" id="logoutLink">
            <i class="fa fa-sign-out" aria-hidden="true"></i><span class="menu-label">Logout</span>
        </a>
    </div>
<div class="docBody">
<div class="content" id="doctorName">Loading doctor's name...</div>
<div id="calendar"></div>
<table id="appointmentsTable" class="table">

    <thead>
    <tr>
        <th>Patient Name</th>
        <th>Appointment Date</th>
        <th>Appointment Time</th>
        <th>Concern</th>
        <th>Status</th>
    </tr>
    </thead>
    <tbody>
    <!-- Appointment rows will be added here dynamically -->
    </tbody>
</table>
<div id="cancelModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span id="closeModal" class="close">&times;</span>
        <h2>Enter Cancellation Reason</h2>
        <textarea id="cancellationReason" placeholder="Enter reason for cancellation"></textarea>
        <div class="buttons">
        <button id="confirmCancelButton" class="cancelButton">Confirm Cancellation</button>
        <button id="backButton" class="back">Back</button>
        </div>
    </div>
</div>
</div>
<script src="/js/toggle.js"></script>

<script>
    let thisCalendar;
    let appointmentToCancel;

    document.addEventListener("DOMContentLoaded", () => {
        fetchUpcomingAppointments();
        initCalendar();

        // Attach event listener to the "Back" button
        document.getElementById("backButton").addEventListener("click", closeModal);
        document.getElementById("closeModal").addEventListener("click", closeModal);
    });

    async function fetchUpcomingAppointments() {
        try {
            const response = await fetch("/api/appointment/upcomingAppointments", {
                method: "GET",
                headers: { "Content-Type": "application/json" }
            });

            if (!response.ok) throw new Error("Network response was not ok");

            const data = await response.json();
            console.log("API Response:", data);

            const doctor = data[0]?.doctor;
            if (doctor && doctor.firstName && doctor.lastName) {
                document.getElementById("doctorName").textContent = `Welcome, Dr. ${doctor.firstName} ${doctor.lastName}`;
            } else {
                throw new Error("Doctor's name not found in response data");
            }

            const filteredAppointments = data.filter(appointment => appointment.status !== 'Canceled');
            populateAppointmentsTable(filteredAppointments);
            populateCalendar(filteredAppointments);

        } catch (error) {
            console.error("Error fetching appointments:", error);
            document.getElementById("doctorName").textContent = "Error loading doctor's name.";
        }
    }

    function populateAppointmentsTable(appointments) {
        const tbody = document.querySelector("#appointmentsTable tbody");
        tbody.innerHTML = "";

        if (appointments.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6">No upcoming appointments found.</td></tr>`;
            return;
        }

        appointments.forEach(appointment => {
            const row = document.createElement("tr");
            const patientName = `${appointment.userID.firstName} ${appointment.userID.lastName}`;
            const appDate = new Date(appointment.appDate).toLocaleDateString();
            const appTime = new Date(`1970-01-01T${appointment.appTime}`).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const concern = appointment.concern;
            const status = appointment.status;

            row.innerHTML = `
                <td>${patientName}</td>
                <td>${appDate}</td>
                <td>${appTime}</td>
                <td>${concern}</td>
                <td>${status}</td>
                <td><button class="cancelButton" onclick="showCancelModal('${appointment.appointmentID}')">Cancel</button></td>
            `;
            tbody.appendChild(row);
        });
    }

    function initCalendar() {
        const calendarEl = document.getElementById('calendar');
        thisCalendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            views: {
                timeGridWeek: {
                    slotDuration: "00:10:00",
                    slotLabelInterval: '00:10:00',
                },
                timeGridDay: {
                    slotDuration: '00:10:00',
                    slotLabelInterval: '00:10:00',
                }
            },
            eventOverlap: false,
            eventMinWidth: 50,
            contentHeight: 'auto',
            height: 'auto',
            eventTimeFormat: {
                hour: 'numeric',
                minute: '2-digit',
                meridiem: 'short'
            },
            eventContent: function(arg) {
                return {
                    html: `<div class="custom-event-content"><span>${arg.event.title}</span></div>`
                };
            }
        });
        thisCalendar.render();
    }

    function populateCalendar(appointments) {
        if (!appointments || appointments.length === 0) {
            console.log("No appointments found for calendar.");
            return;
        }

        try {
            const events = appointments.map(appointment => {
                const start = new Date(`${appointment.appDate}T${appointment.appTime}`);
                const duration = appointment.doctor.avg_time || 30;
                const end = new Date(start.getTime() + duration * 60000);

                return {
                    title: `${appointment.appTime} - ${appointment.userID.firstName} ${appointment.userID.lastName}`,
                    start: start.toISOString(),
                    end: end.toISOString()
                };
            });

            thisCalendar.addEventSource(events);
        } catch (error) {
            console.error("Error populating calendar:", error);
        }
    }

    function showCancelModal(appointmentId) {
        appointmentToCancel = appointmentId;
        document.getElementById("cancelModal").style.display = "flex";
    }

    document.getElementById("confirmCancelButton").addEventListener("click", async () => {
        const reason = document.getElementById("cancellationReason").value.trim();
        if (!reason) {
            alert("Please enter a reason for cancellation.");
            return;
        }

        await cancelAppointment(appointmentToCancel, reason);
        closeModal();
    });

    function closeModal() {
        document.getElementById("cancelModal").style.display = "none";
        document.getElementById("cancellationReason").value = "";
    }

    async function cancelAppointment(appointmentId, reason) {
        try {
            const response = await fetch(`http://localhost:8081/api/appointment/cancel/${appointmentId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cancellationReason: reason })
            });

            const contentType = response.headers.get("content-type");
            let result;

            if (contentType && contentType.includes("application/json")) {
                result = await response.json();
                console.log('Response Body (JSON):', result);
            } else {
                result = await response.text();
                console.log('Response Body (Text):', result);
            }

            if (response.ok) {
                alert("Appointment canceled successfully");
                await fetchUpcomingAppointments();
            } else {
                console.error('Failed to cancel appointment:', result);
                alert(`Failed to cancel appointment: ${result}`);
            }
        } catch (error) {
            console.error('Error canceling appointment:', error);
        }
    }
</script>
</body>
</html>
