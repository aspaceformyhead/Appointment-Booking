<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.2/main.min.js"></script>
    <link rel="stylesheet" href="css/docView.css">
    <title>Doctor's Upcoming Appointments</title>


</head>
<body>

<div class="doctor-name" id="doctorName">Loading doctor's name...</div>
<div id="calendar"></div>
<table id="appointmentsTable" class="table">

    <thead>
    <tr>
        <th>Patient Name</th>
        <th>Appointment Date</th>
        <th>Appointment Time</th>
        <th>Concern</th>
        <th>Status</th>
    </tr>
    </thead>
    <tbody>
    <!-- Appointment rows will be added here dynamically -->
    </tbody>
</table>

<script>
    document.addEventListener("DOMContentLoaded", () => {
    fetchUpcomingAppointments();
    initCalendar();
});

async function fetchUpcomingAppointments() {
  try {
    const response = await fetch("/api/appointment/upcomingAppointments", {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    });
    let thisCalendar;

    if (!response.ok) {
      throw new Error("Network response was not ok");
    }

    const data = await response.json();  

    console.log("API Response:", data);  


    // Check if data contains doctor's name
    if (!data || !data.length || !data[0].doctor || !data[0].doctor.firstName || !data[0].doctor.lastName) {
      throw new Error("Doctor's name not found in response data");
    }

    // Retrieve doctor's name
    const doctorName = `${data[0].doctor.firstName} ${data[0].doctor.lastName}`;
    document.getElementById("doctorName").textContent = `Welcome, Dr. ${doctorName}`;

    // Populate the appointments table
    populateAppointmentsTable(data);
    // Call populateCalendar after data is available
    populateCalendar(data);
  }
   catch (error) {
    console.error("Error fetching appointments:", error);
    document.getElementById("doctorName").textContent = "Error loading doctor's name.";
  }
}

function populateAppointmentsTable(appointments) {
console.log("Appointments data:", appointments);
    const tbody = document.querySelector("#appointmentsTable tbody");
    tbody.innerHTML = ""; // Clear existing rows
    if (appointments.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="5">No upcoming appointments found.</td>`;
        tbody.appendChild(row);
        return;
    }

    appointments.forEach(appointment => {
        const row = document.createElement("tr");
        const patientName = `${appointment.userID.firstName} ${appointment.userID.lastName}`;
        const appDate = appointment.appDate.toString(); // Adjust format as needed
        const appTime = appointment.appTime.toString(); // Adjust format as needed
        const concern = appointment.concern;
        const status = appointment.status;

        row.innerHTML = `
            <td>${patientName}</td>
            <td>${appDate}</td>
            <td>${appTime}</td>
            <td>${concern}</td>
            <td>${status}</td>
        `;

        tbody.appendChild(row);
    });
}
    function initCalendar() {
        const calendarEl = document.getElementById('calendar');
        thisCalendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', // Month view
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            views:{
              timeGridWeek:{ slotDuration: "00:10:00", // Use the dynamic slot duration
              slotLabelInterval: '00:10:00',},
             
            timeGridDay:{
              slotDuration: '00:10:00', // Set slot duration for day view
                slotLabelInterval: '00:10:00',

            }
          },
        eventOverlap: false, // Prevent events from overlapping
        eventMinWidth: 50, // Ensure minimum width for events
        contentHeight: 'auto', // Adjust height dynamically
        height: 'auto', // Ensure calendar height adjusts to content
        eventTimeFormat: {
            hour: 'numeric',
            minute: '2-digit',
            meridiem: 'short' // Short format for PM/AM
        },
        eventContent: function(arg) {
            return {
                html: `<div class="custom-event-content">
                         <span>${arg.event.title}</span>
                       </div>`
            };
        }
        });
        
  thisCalendar.render();

    }

    // Populate the calendar with appointment data
   function populateCalendar(appointments) {
  if (!appointments || appointments.length === 0) {
    console.log("No appointments found for calendar.");
    return;
  }

  try {
    //
    // Create calendar events
    const events = appointments.map(appointment => {
      
    const appointmentDateTime=`${appointment.appDate}T${appointment.appTime}`;
    const appointmentDurationMinutes = appointment.doctor.avg_time; // Get this from your data source
    const start = new Date(appointmentDateTime);
    const end = new Date(start.getTime() + appointmentDurationMinutes * 60000); // Add duration in milliseconds

    
      return {
        title: `${appointment.appTime} - ${appointment.userID.firstName} ${appointment.userID.lastName}`,
        start: start.toISOString(),
        end:end.toISOString()
       
        
      };
    });

    // Add events to the calendar
    thisCalendar.addEventSource(events);
  } catch (error) {
    console.error("Error populating calendar:", error);
    // Handle error gracefully, e.g., display an error message
  }
}

</script>
</body>
</html>
