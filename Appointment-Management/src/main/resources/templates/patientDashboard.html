<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/booking.css">
    <link rel="stylesheet" href="/css/register.css">


</head>
<body>

    <!-- Sidebar for menu options -->
    <div class="sidebar" id="sidebar">
        <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>

        <a href="#appointments" >
            <i class="fa fa-history" aria-hidden="true"></i> <span class="menu-label">Appointments</span>
        </a>
        <a href="#bookAppointments" class="active">
            <i class="fa fa-calendar-o" aria-hidden="true"></i>
        <span class="menu-label"> Book Appointments</span>
        </a>
        <a href="#profile">
            <i class="fa fa-user" aria-hidden="true"></i>
 <span class="menu-label">Profile</span>
        </a>
        <a href="#logout">
            <i class="fa fa-sign-out" aria-hidden="true"></i><span class="menu-label">Logout</span>
        </a>
    </div>

    <!-- Main content area -->
    <div class="content">
        <div id="appointments" style="display: none;">
            <h2> Appointment History</h2>
            <table class="appointment-table">
                <thead>
                <tr>
                    <th>Doctor</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Concern</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody class="appointment-list">
                <!-- Appointment rows will be dynamically inserted here -->
                </tbody>        <!-- Insert appointment details dynamically here -->
            </table>

            <div id="cancelModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <span id="closeModal" class="close">&times;</span>
                    <h2>Enter Cancellation Reason</h2>
                    <textarea id="cancellationReason" placeholder="Enter reason for cancellation"></textarea>
                    <div class="buttons">
                        <button id="confirmCancelButton" class="cancelButton">Confirm Cancellation</button>
                        <button id="backButton" class="back">Back</button>
                    </div>
                </div>
            </div>

        </div>

        <div id="bookAppointments" >
            
                            
                <form action="api/appointment/create" method="post" class="form-booking">
                <div>
                    <label for="concern"> Area of concern</label>
                    <input type="text" name="concern" id="concern" placeholder="Eg:Chest">
                </div>
                    <div >
                        <label for="organization">Hospital</label>
                        <select name="organization" id="organization" required>
                            <option value="">Select Employer</option>
                        </select>
                    </div>
                <div>
                    <label > Select Doctor: </label>
                    <select id="doctorDropdown" onchange="updateAvailableTimes(); setDoctorID();" >
                        <option value="" disabled selected> Select a Doctor</option>

                    </select>
                </div>
                <input type="hidden" name="doctorID" id="doctorID">

            <div>
            <label for="appDate"> Select Date</label>
            <input type="date" name="appDate" id="appDate" placeholder="Select a date" onchange="updateAvailableDates()">
            </div>
            <div>
                <label for="appTime">Select Time</label>
                <select name="appTime" id="appTime" required>
                    <option value="" disabled selected>Select a time</option>
                </select>
            </div>

                <div>
                    <button class="button"> CONFIRM BOOKING </button>
                </div>

            </form>

        </div>

        <div id="profile" style="display: none;">
            <div class="account-settings-nav">
                <ul>
                    <li><a class="nav-label active" href="#editProfile">Edit Profile</a></li>
                    <li><a class="nav-label" href="#changePassword">Change Password</a></li>
                    <li><a class="nav-label" href="#deleteAccount">Delete Account</a></li>
                    <li><a class="nav-label" href="#languageRegion">Language & Region Settings</a></li>
                </ul>
            </div>
            <section id="editProfile" class="active">
            <div class="profile-picture-section">

                <img id="profilePicture" src="default-profile.png" alt="Profile Picture" class="profile-picture">
                <div class="button-group">
                    <button type="button" id="changeImageButton">Change Image</button>
                    <button type="button" id="removeImageButton" class="redButton">Remove Image</button>
                </div>
                </div>
            

            <form action="/api/user/updateProfile" method="GET" class="form-container">
                <!-- First Row: First Name, Middle Name, Last Name -->
            <div class="form-row">
                <div class="form-field">
                    <label for="firstName">First Name</label>
                    <input type="text" id="firstName" placeholder="First name" name="firstName" >
                </div>
                <div class="form-field">
                    <label for="middleName">Middle Name</label>
                    <input type="text" id="middleName" placeholder="Middle name" name="middleName">
                </div>
                <div class="form-field">
                    <label for="lastName">Last Name</label>
                    <input type="text" id="lastName" placeholder="Last name" name="lastName">

                </div>
            </div>
            <div class="form-row">

                <!-- Second Row: Email, Contact Number -->
                <div class="form-field">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="eg: abc@gmail.com" name="email" >
                </div>
                <div class="form-field">
                    <label for="mobileNumber">Contact Number</label>
                    <input type="text" id="mobileNumber" placeholder="Phone number" name="mobileNumber">
                </div>
            </div>


                <!-- Buttons Row -->
                <div class="form-row">
                    <button class=" button primary" type="submit">SAVE CHANGES</button>
                    <button class="button redButton" onclick="">CANCEL</button>
                </div>
                
            </form>
        </section>
        <section id="changePassword" style="display: none;">

            <form action="">
                <div class="form-field">
                    <label for="currentPassword"> Cureent Password</label>
                    <input type="password" id="currentPassword" name="currentPassword" required placeholder="Enter your current Password">

                </div>
                <div class="form-field">
                    <label for="newPassword"> New Password</label>
                    <input type="password" id="newPassword" name="newPassword" required placeholder="Enter your new password">

                </div>
                <div class="form-field">
                    <label for="confirmNewPassword">Confirm New Password</label>
                    <input type="password" id="confirmNewPassword" name="confirmNewPassword" required placeholder="Re-eneter ypur new password for confirmation">

                </div>
                <div class="form-field">
                    <button type="submit" class="button primary"> Change Password</button>
                    <button class="primay cancelButton"> Cancel</button>
                </div>
            </form>
        </section>
        </div>

        <div id="logout" style="display: none;">
            <h2>Logout</h2>
            <p>You have successfully logged out.</p>
            <!-- You could add a logout confirmation or redirect here -->
        </div>
    </div>
    <script src="../js/booking.js"></script>
    <script>
// 
        function toggleSidebar() {
            const sidebar = document.getElementById("sidebar");
            sidebar.classList.toggle("collapsed");}
        

        // JavaScript to handle navigation and content display
        const menuItems = document.querySelectorAll('.sidebar a ');
        const contentSections = document.querySelectorAll('.content > div');

        menuItems.forEach(item => {
            item.addEventListener('click', function(event) {
                event.preventDefault();
                // Remove active class from all menu items and hide all content sections
                menuItems.forEach(i => i.classList.remove('active'));
                contentSections.forEach(section => section.style.display = 'none');

                // Set clicked menu item to active and display corresponding content section
                item.classList.add('active');
                const sectionId = item.getAttribute('href').substring(1);
                document.getElementById(sectionId).style.display = 'flex';
                document.getElementById(sectionId).style.flexDirection = 'column';

            });
        });
        document.getElementById("bookAppointments").style.display = "block";
    

        function toggleProfileSection() {
    const navItems = document.querySelectorAll('.nav-label');
    const profileSections = document.querySelectorAll('#profile > section');

    navItems.forEach(item => {
        item.addEventListener('click', function(event) {
            event.preventDefault();
            // Remove 'active' class from all nav items and hide all profile sections
            navItems.forEach(i => i.classList.remove('active'));
            profileSections.forEach(section => section.style.display = 'none');

            // Set the clicked nav item to 'active' and display the corresponding section
            item.classList.add('active');
            const sectionId = item.getAttribute('href').substring(1);
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'flex';
                targetSection.style.flexDirection = 'column';
            }
        });
    });

    // Display default section on load
    document.getElementById("editProfile").style.display = "flex";
}toggleProfileSection();
        //Appointment Booking Form





function loadAppointmentHistory() {
    fetch('api/appointment/getAppointmentHistory')  // Replace with actual API endpoint for fetching history
        .then(response => response.json())
        .then(data => {
            console.log(data);
            const appointmentList = document.querySelector('.appointment-list');
            appointmentList.innerHTML = ''; // Clear existing content

            // Check if there are any appointments
            if (data.length === 0) {
                appointmentList.innerHTML = '<p>No appointments found.</p>';
                return;
            }

            // Loop through the data and create appointment elements
            data.forEach(appointment => {
                const appDate = new Date(appointment.appDate).toLocaleDateString();
                const appTime = appointment.appTime;
                const row = document.createElement('tr');

                // Add HTML content for each appointment's details
                row.innerHTML = `
                    <td>${appointment.doctor.firstName} &nbsp ${appointment.doctor.lastName}</td>
                    <td>${appDate}</td>
                    <td>${appTime}</td>
                    <td>${appointment.concern}</td>
                    <td>${appointment.status}</td>
                    <td>${appointment.status === 'confirmed'
        ? `<button class='cancel-button' onclick="showCancelModal('${appointment.appointmentID}')">Cancel</button>`
        : 'None'
    }</td>
                `;

                //const appointmentDateTime = new Date(`${appointment.appDate}T${appointment.appTime}`);
                //if (appointmentDateTime > new Date()) {
                //    const cancelButton = document.createElement('button');
                //    cancelButton.classList.add('cancel-button');
                //    cancelButton.textContent = 'Cancel';
                //    cancelButton.onclick = () => showCancelModal(appointment.appointmentID);
                //    const cell = document.createElement('td');
                //    cell.appendChild(cancelButton);
                //    row.appendChild(cell);
                //} else {
                //    row.innerHTML += '<td></td>';
                //}

                // Append the appointment row to the appointment list
                appointmentList.appendChild(row);
            });
        })
        .catch(error => console.error('Error fetching appointment history:', error));
}

    function showCancelModal(appointmentId) {
        appointmentToCancel = appointmentId;
        document.getElementById("cancelModal").style.display = "flex";
    }
    function closeModal() {
        document.getElementById("cancelModal").style.display = "none";
        document.getElementById("cancellationReason").value = "";
    }

     function cancelAppointment(appointmentId,cancellationReason) {

    if (!cancellationReason) {
        alert('Please provide a reason for cancellation.');
        return;
    }

    fetch(`http://localhost:8081/api/appointment/cancel/${appointmentId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            appointmentId: appointmentToCancel,
            cancellationReason: cancellationReason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Appointment canceled successfully.');
            loadAppointmentHistory();
             alert("Appointment canceled sucessfully");// Reload the appointment history to reflect the cancellation
            closeModal();  // Close the modal
        } else {
            alert('Failed to cancel the appointment. Please try again.');
        }

    })
    .catch(error => console.error('Error canceling appointment:', error));
}
document.getElementById('confirmCancelButton').addEventListener('click', async()=> {
    const reason=document.getElementById("cancellationReason").value.trim();
    if (!reason) {
            alert("Please enter a reason for cancellation.");
            return;
        }
  await cancelAppointment(appointmentToCancel, reason); 
  closeModal();// Call the correct function
});



    // Handle the back button in the cancel modal
    document.getElementById('backButton').addEventListener('click', function() {
        document.getElementById('cancelModal').style.display = 'none';
    });

    // Function to close the modal when the close button is clicked
    document.getElementById('closeModal').addEventListener('click', function() {
        document.getElementById('cancelModal').style.display = 'none';
    });


            document.querySelector('a[href="#appointments"]').addEventListener('click', loadAppointmentHistory);
    </script>
</body>
</html>
